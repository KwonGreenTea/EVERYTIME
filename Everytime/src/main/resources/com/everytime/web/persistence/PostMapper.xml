<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.everytime.web.persistence.PostMapper">

	<resultMap type="com.everytime.web.domain.PostVO"
		id="postResultMap">
		<id property="postId" column="POST_ID" />
		<result property="boardId" column="BOARD_ID" />
		<result property="memberId" column="MEMBER_ID" />
		<result property="postTitle" column="POST_TITLE" />
		<result property="postContent" column="POST_CONTENT" />
		<result property="postCreatedDate" column="POST_CREATED_DATE" />
		<result property="postLikeCount" column="POST_LIKE_COUNT" />
		<result property="postScrapCount" column="POST_SCRAP_COUNT" />
		<result property="postAnonymous" column="POST_ANONYMOUS" />
	</resultMap>

	<resultMap type="com.everytime.web.domain.FileVO"
		id="FileResultMap">
		<id property="boardId" column="BOARD_ID" />
		<result property="postPath" column="POST_PATH" />
		<result property="postRealName" column="POST_REAL_NAME" />
		<result property="postChgName" column="POST_CHG_NAME" />
		<result property="postExtension" column="POST_EXTENSION" />
		<result property="postId" column="POST_ID" />
	</resultMap>

	<!-- <insert id="insert"> INSERT INTO POST ( POST_ID, BOARD_ID, MEMBER_ID, 
		POST_TITLE, POST_CONTENT, POST_CREATED_DATE, POST_ANONYMOUS, POST_PATH, POST_REAL_NAME, 
		POST_CHG_NAME, POST_EXTENSION ) SELECT project.post_id_seq.nextval, #{boardId}, 
		#{memberId}, #{postTitle}, #{postContent}, SYSDATE, NVL(#{postAnonymous, 
		jdbcType=CHAR}, '0'), #{postPath}, #{postRealName}, #{postChgName}, #{postExtension} 
		FROM dual </insert> -->

	<!-- 게시글 삽입 -->
	<insert id="insert">
		INSERT INTO POST
		VALUES (#{boardId},
		project.post_id_seq.nextval,
		#{memberId}, #{postTitle},
		#{postContent},
		SYSDATE, 0, 0,
		NVL(#{postAnonymous,
		jdbcType=CHAR}, '0')
		)
	</insert>

	<insert id="insertFile">
		INSERT INTO IMG_FILE
		VALUES (#{boardId},
		#{postPath,
		jdbcType=VARCHAR},
		#{postRealName, jdbcType=VARCHAR},
		#{postChgName,
		jdbcType=VARCHAR},
		#{postExtension, jdbcType=VARCHAR},
		#{postId}
		)
	</insert>

	<select id="selectPostList" resultMap="postResultMap">
		<!-- 전체 게시글 조회 select a.*, b.nickname from post a, member b where board_id 
			= #{boardId} and a.member_id = b.member_id order by post_id desc -->
		select *
		from post
		where board_id = #{boardId}
		order by post_id desc
		<!-- SELECT BOARD_ID, BOARD_TITLE, BOARD_CONTENT, MEMBER_ID, BOARD_DATE_CREATED 
			FROM BOARD와 동일 -->
	</select>

	<select id="selectPostImgList" resultMap="FileResultMap">
		SELECT * FROM IMG_FILE
		where board_id = #{boardId}
		order by post_id desc
	</select>

	<select id="getPostById" resultMap="postResultMap">
		SELECT BOARD_ID,
		POST_ID,
		MEMBER_ID,
		POST_TITLE,
		POST_CONTENT,
		POST_CREATED_DATE,
		POST_LIKE_COUNT,
		POST_SCRAP_COUNT,
		POST_ANONYMOUS
		FROM post
		WHERE BOARD_ID = #{boardId}
		AND POST_ID = #{postId}
	</select>

	<select id="getPostDataByPostId" resultMap="postResultMap">
		SELECT * FROM POST
		WHERE POST_ID = #{postId}
	</select>

	<select id="getId" resultType="String">
		SELECT MEMBER_ID
		FROM post
		WHERE
		BOARD_ID = #{boardId}
		AND POST_ID = #{postId}
	</select>

	<select id="getImgById" resultMap="FileResultMap">
		SELECT * FROM IMG_FILE
		WHERE
		BOARD_ID = #{boardId}
		AND POST_ID = #{postId}
	</select>

	<select id="postIdByMemberId" resultType="int">
		SELECT MAX(POST_ID)
		FROM POST
		WHERE MEMBER_ID = #{memberId}
	</select>

	<update id="update">
		UPDATE post
		SET BOARD_ID = #{boardId},
		MEMBER_ID =
		#{memberId},
		POST_TITLE = #{postTitle},
		POST_CONTENT = #{postContent},
		POST_CREATED_DATE = #{postCreatedDate},
		POST_LIKE_COUNT =
		#{postLikeCount},
		POST_SCRAP_COUNT = #{postScrapCount},
		POST_ANONYMOUS =
		#{postAnonymous}
		WHERE POST_ID = #{postId}
	</update>

	<delete id="delete">
		DELETE FROM post
		WHERE POST_ID = #{postId}
	</delete>


	<!-- 게시글 좋아요 수 업데이트 -->
	<update id="updatePostLike">
		UPDATE POST

		SET POST_LIKE_COUNT = POST_LIKE_COUNT +1

		WHERE POST_ID = #{postId}

	</update>

	<update id="updatePostScrap">
		UPDATE POST

		SET POST_SCRAP_COUNT = POST_SCRAP_COUNT +1

		WHERE POST_ID = #{postId}

	</update>

	<update id="deletePostScrap">
		UPDATE POST

		SET POST_SCRAP_COUNT = POST_SCRAP_COUNT -1

		WHERE POST_ID = #{postId}

	</update>

	<!-- 게시글 검색 -->

	<select id="searchPost" resultMap="postResultMap">

		SELECT * FROM POST

		WHERE POST_TITLE LIKE '%' || #{keyword} || '%'
		OR POST_CONTENT LIKE '%' ||
		#{keyword} || '%'


	</select>

	<!-- hot 게시글 검색 -->

	<select id="selectHopPost" resultMap="postResultMap">

		SELECT * FROM POST
		WHERE POST_LIKE_COUNT >= 1
		ORDER BY POST_ID DESC

	</select>

</mapper>
